From 1930610cc18e3ddea6faff1669e4aa5425995ad8 Mon Sep 17 00:00:00 2001
From: lishengjie <lishengjie12@huawei.com>
Date: Sat, 15 Jul 2023 14:59:21 +0800
Subject: [PATCH] add link to so

---
 Makefile                     | 20 ++++++++++++++++++++
 test/CA/tee_upgrade/Makefile |  9 +++++----
 2 files changed, 25 insertions(+), 4 deletions(-)
 create mode 100644 Makefile

diff --git a/Makefile b/Makefile
new file mode 100644
index 0000000..e227f62
--- /dev/null
+++ b/Makefile
@@ -0,0 +1,20 @@
+CUR_DIR=$(shell pwd)
+iTrustee_SDK_PATH=${CUR_DIR}
+TARGET_APP := libteec_adaptor.so.1
+SO_NAME := libteec_adaptor.so
+
+APP_SOURCES += $(iTrustee_SDK_PATH)/src/CA/libteec_adaptor.c
+APP_CFLAGS += -fstack-protector-strong -fPIC -ftrapv -s -D_FORTIFY_SOURCE=2 -O2
+APP_CFLAGS += -I$(iTrustee_SDK_PATH)/include/CA -I$(iTrustee_SDK_PATH)/thirdparty/open_source/libboundscheck/include
+
+APP_LDFLAGS += -z text -z now -z relro -z noexecstack -pie -shared
+$(TARGET_APP): $(APP_SOURCE)
+	@$(CC) $(APP_CFLAGS) $(APP_LDFLAGS) $(APP_SOURCES) -Wl,-soname,$(SO_NAME) -o $@
+	@ln -s libteec_adaptor.so.1 libteec_adaptor.so
+
+install: $(TARGET_APP)
+	install -d /opt/itrustee_sdk
+	cp -r build include License thirdparty /opt/itrustee_sdk
+	install -pm 644 libteec_adaptor.so /lib64/ 
+clean:
+	rm -rf *.o $(TARGET_APP)
diff --git a/test/CA/tee_upgrade/Makefile b/test/CA/tee_upgrade/Makefile
index 34fdfa0..7566ad1 100644
--- a/test/CA/tee_upgrade/Makefile
+++ b/test/CA/tee_upgrade/Makefile
@@ -2,13 +2,14 @@
 obj-m := tee_upgrade.o
 tee_upgrade-objs := upgrade.o
 
-EXTRA_CFLAGS += -I$(PWD)/../../../thirdparty/open_source/libboundscheck/include
+EXTRA_CFLAGS += -I$(PWD)/libboundscheck/include
 
-KPATH	:= /usr/src/kernels
-KDIR	:= $(KPATH)/$(shell ls $(KPATH))
+KPATH := /usr/src/kernels
+KERNEL_VERSION := $(shell rpm -qa|grep kernel-devel | head -n 1 | awk -F "kernel-devel-" '{print $$2}')
+KDIR  := $(KPATH)/$(KERNEL_VERSION)
 
 #The dynamic upgrade of tee depends on the tzdriver library.
-EXTRA_CFLAGS += -I$(PWD)/../tzdriver
+EXTRA_CFLAGS += -I$(PWD)/../driver/itrustee_tzdriver
 
 all:
 	make -C $(KDIR) M=$(PWD) modules
-- 
2.27.0

